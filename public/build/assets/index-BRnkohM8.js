import{q as M,r as N,t as o,m as p,j as s,L as J,B as K,T as Q}from"./app-CD6cBdKM.js";import{o as W,b as C,u as X,a as Y,s as m,i as Z,n as U,c as ee,g as se,F as ae,d as n}from"./form-provider-C9b8JaXX.js";import"./styles-gzNUAspH.js";import"./order-complete-illustration-KAH1HJrN.js";import{u as te}from"./useLang-BvyXRUe-.js";import{r as u}from"./route-qstKo99j.js";import{C as re}from"./confirm-dialog-CDC-gDHT.js";import{u as oe}from"./authz-DzcDTZqa.js";import{G as g}from"./Grid-KnF3kKah.js";import{C as w}from"./Card-4eiaUBLO.js";import{S as E}from"./Stack-vomvaMcO.js";import{B as f}from"./Button--KfC8rp5.js";import"./TextField-Dh4fcTDh.js";import"./Popover-6bJkE66t.js";import"./createSvgIcon-BRtoGIw2.js";import"./FormControlLabel-DrSLr8OZ.js";import"./Chip-BNrhAUiE.js";import"./merge-y9PmGEhP.js";import"./MenuItem-DmaGw-zu.js";import"./Checkbox-BMTKf5nZ.js";import"./Dialog-CFRChwGj.js";import"./useThemeProps-DzpMU5fq.js";function De({roles:F,currentUser:a}){var j;const{__:e}=te(),{props:x}=M(),h=x.csrf_token,b=(j=x.auth.user)==null?void 0:j.id,{can:k}=oe(),D=k("USERS_DELETE"),[A,l]=N.useState(!1),B=W({name:m().min(1,{message:e("validation.required",{attribute:e("validation.attributes.name")})}),email:m().email({message:e("validation.email",{attribute:e("validation.attributes.email")})}),roles:Y(m()).min(1,{message:e("validation.required",{attribute:e("validation.attributes.roles")})}),avatar:X([Z(File),m(),U()]).nullable(),banned:C(),email_verified:C()}),v=ee({resolver:se(B),mode:"onChange",defaultValues:{name:a.name,email:a.email,roles:a.roles.map(String),avatar:a.avatar??null,banned:a.status==="banned",email_verified:!!a.email_verified_at}}),{handleSubmit:L,setError:O,watch:z,formState:{isSubmitting:R}}=v,q=F.map(t=>({label:e(`pages/users.roles.${t.name.toLowerCase()}`),value:String(t.id)})),_=z("banned")?"banned":a.status==="pending"?"pending":"active",I={active:"success",pending:"warning",banned:"error"}[_],P=L(t=>{const S=t.banned?"banned":a.status==="pending"?"pending":"active",d=t.roles.map(Number).sort(),T=[...a.roles].sort(),y=d.length!==T.length||d.some((i,c)=>i!==T[c]),V=t.avatar instanceof File,$=t.email_verified!==!!a.email_verified_at;if(!(t.name!==a.name||t.email!==a.email||S!==a.status||y||V||$)){o.error(e("pages/users.no_changes"));return}if(a.id===b&&y){o.error(e("pages/users.self_role_error"));return}const r=new FormData;r.append("_token",h),r.append("_method","PATCH"),r.append("name",t.name),r.append("email",t.email),d.forEach(i=>r.append("roles[]",String(i))),r.append("status",S),r.append("email_verified_at",t.email_verified?new Date().toISOString():""),t.avatar instanceof File&&r.append("avatar",t.avatar),p.post(u("users.update",a.id),r,{onSuccess:()=>{o.success(e("pages/users.update_success")),p.reload()},onError:i=>{Object.entries(i).forEach(([c,H])=>{O(c,{type:"server",message:H})}),o.error(i.roles??e("pages/users.update_error"))}})}),G=()=>{if(a.id===b){o.error(e("pages/users.self_delete_error")),l(!1);return}p.delete(u("users.destroy",a.id),{data:{_token:h},onSuccess:()=>{o.success(e("pages/users.delete_success")),l(!1),p.visit(u("users.index"))},onError:t=>{o.error(t.user??e("pages/users.delete_error")),l(!1)}})};return s.jsxs(s.Fragment,{children:[s.jsx(ae,{methods:v,onSubmit:P,children:s.jsxs(g,{container:!0,spacing:3,children:[s.jsx(g,{size:{xs:12,md:4},children:s.jsxs(w,{sx:{pt:10,pb:5,px:3},children:[s.jsx(J,{color:I,sx:{position:"absolute",top:24,right:24},children:e(`pages/users.statuses.${_}`)}),s.jsxs(E,{spacing:3,alignItems:"center",children:[s.jsx(K,{sx:{mb:5},children:s.jsx(n.UploadAvatar,{name:"avatar",accept:{"image/jpeg":[],"image/png":[],"image/gif":[]},maxSize:3145728,helperText:s.jsx(Q,{variant:"caption",color:"text.secondary",sx:{mt:3,mx:"auto",display:"block",textAlign:"center",color:"text.disabled"},children:e("pages/users.form.avatar_helper")})})}),s.jsx(n.Switch,{name:"banned",label:e("pages/users.form.banned"),helperText:e("pages/users.form.banned_caption"),slotProps:{wrapper:{sx:{width:1}},helperText:{sx:{textAlign:"left"}}}}),s.jsx(n.Switch,{name:"email_verified",label:e("pages/users.form.email_verified"),helperText:e("pages/users.form.email_verified_caption"),slotProps:{wrapper:{sx:{width:1}},helperText:{sx:{textAlign:"left"}}}}),D&&s.jsx(f,{color:"error",variant:"soft",sx:{mt:1,alignSelf:"stretch"},onClick:()=>l(!0),children:e("pages/users.delete_user")})]})]})}),s.jsx(g,{size:{xs:12,md:8},children:s.jsx(w,{sx:{p:3},children:s.jsxs(E,{spacing:3,children:[s.jsx(n.Text,{name:"name",label:e("pages/users.form.name")}),s.jsx(n.Text,{name:"email",label:e("pages/users.form.email")}),s.jsx(n.MultiSelect,{name:"roles",label:e("pages/users.form.roles"),options:q,placeholder:"",checkbox:!0}),s.jsx(f,{type:"submit",variant:"contained",loading:R,sx:{ml:"auto"},children:e("pages/users.form.submit_update")})]})})})]})}),s.jsx(re,{open:A,onClose:()=>l(!1),title:e("pages/users.delete_user"),content:e("pages/users.delete_confirm"),action:s.jsx(f,{color:"error",variant:"contained",onClick:G,children:e("pages/users.delete")})})]})}export{De as EditUserForm};
